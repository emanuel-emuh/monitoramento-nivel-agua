<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Administrador</title>
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>
    <nav class="navbar"></nav>
    <section id="home"></section>
    <section id="users"></section>

    <section id="settings" style="padding-top: 2rem;">
        <div class="container">
             <div class="settings-card" id="system-settings-card">
                <h4>Configurações do Sistema</h4>
                <div class="control-group">
                    <label for="low-limit-input">Ligar Bomba Abaixo de (%):</label>
                    <input type="number" id="low-limit-input">
                </div>
                <div class="control-group">
                    <label for="high-limit-input">Desligar Bomba Acima de (%):</label>
                    <input type="number" id="high-limit-input">
                </div>
                <button id="save-settings-button" class="btn-motor-off" style="width: 100%; margin-top: 1rem;">Salvar Configurações</button>
                <p id="settings-feedback" style="text-align: center; color: green; margin-top: 1rem;"></p>
            </div>
            <div class="settings-card" style="margin-top: 2rem; border-top-color: #dc3545;" id="data-management-card">
                <h4>Gerenciamento de Dados</h4>
                <div class="control-group">
                    <label for="pause-switch">Coleta de dados do sensor:</label>
                    <label class="switch"><input type="checkbox" id="pause-switch"><span class="slider round"></span></label>
                </div>
                <div class="control-group">
                    <label>Limpar dados de consumo:</label>
                    <button id="clear-history-button" style="background-color: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">Limpar Histórico</button>
                </div>
                <p class="settings-info"><b>Pausar Coleta:</b> Impede o ESP de enviar novos dados. <b>Limpar Histórico:</b> Apaga todos os registros de nível do banco de dados.</p>
            </div>
        </div>
    </section>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBOBbMzkTO2MvIxExVO8vlCOUgpeZp0rSY",
            authDomain: "aqua-monitor-login.firebaseapp.com",
            projectId: "aqua-monitor-login",
            databaseURL: "https://aqua-monitor-login-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const functions = firebase.functions();

        document.addEventListener('DOMContentLoaded', function () {
            // (Lógica de segurança e logout)

            // --- REFERÊNCIAS ---
            const lowLimitInput = document.getElementById('low-limit-input');
            const highLimitInput = document.getElementById('high-limit-input');
            const pauseSwitch = document.getElementById('pause-switch');
            const settingsFeedback = document.getElementById('settings-feedback');
            const settingsRef = database.ref('configuracoes/sistema');

            // --- CARREGA E EXIBE AS CONFIGURAÇÕES ATUAIS ---
            settingsRef.on('value', snapshot => {
                if (snapshot.exists()) {
                    const settings = snapshot.val();
                    lowLimitInput.value = settings.limiteInferior || 50;
                    highLimitInput.value = settings.limiteSuperior || 95;
                    // O switch representa a coleta PAUSADA. Se coletaAtiva for false, o switch deve estar marcado.
                    pauseSwitch.checked = (settings.coletaAtiva === false);
                }
            });

            // --- AÇÕES DOS BOTÕES ---
            document.getElementById('save-settings-button').addEventListener('click', () => {
                const newLow = parseInt(lowLimitInput.value);
                const newHigh = parseInt(highLimitInput.value);
                if (newLow >= newHigh) {
                    alert('O limite para ligar deve ser menor que o limite para desligar.');
                    return;
                }
                settingsRef.update({ limiteInferior: newLow, limiteSuperior: newHigh })
                    .then(() => {
                        settingsFeedback.textContent = 'Limites salvos com sucesso!';
                        setTimeout(() => { settingsFeedback.textContent = ''; }, 3000);
                    })
                    .catch(err => alert('Erro ao salvar limites: ' + err.message));
            });
            
            pauseSwitch.addEventListener('change', () => {
                const isPaused = pauseSwitch.checked;
                // A coleta está ATIVA se o botão de pausar estiver DESMARCADO.
                settingsRef.update({ coletaAtiva: !isPaused });
            });

            document.getElementById('clear-history-button').addEventListener('click', () => {
                if (!confirm('Tem certeza? Esta ação apagará TODO o histórico de forma irreversível.')) return;
                const clearHistoryFunction = functions.httpsCallable('clearHistory');
                alert("Iniciando limpeza do histórico...");
                clearHistoryFunction()
                    .then(() => alert("Histórico limpo com sucesso!"))
                    .catch(error => alert("Erro: " + error.message));
            });

            // (O restante do código para visão geral e gerenciar usuários permanece o mesmo)
        });
    </script>
</body>
</html>
