<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AquaMonitor - Painel do Administrador</title>
  <link rel="stylesheet" href="admin.css" />
  <style>
    .tank-visualization-container {
      display: flex;
      justify-content: space-around;
      align-items: flex-end;
      gap: 2rem;
      margin-top: 2rem;
      background-color: #f8f9fa;
      padding: 2rem;
      border-radius: 8px;
      min-height: 250px;
      border: 1px solid #e9ecef;
    }
    .tank {
      width: 100px;
      height: 200px;
      border: 3px solid #6c757d;
      border-radius: 5px;
      position: relative;
      background-color: #e9ecef;
      overflow: hidden;
    }
    .water-level {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      transition: height 0.5s ease;
      border-radius: 0 0 2px 2px;
    }
    .tank-label {
      text-align: center;
      margin-top: 0.5rem;
      font-weight: 600;
      color: #495057;
    }
  </style>
</head>

<body>
  <nav class="navbar">
    <div class="logo">
      <div class="logo-icon">AM</div>
      <h1>AquaMonitor - Admin</h1>
    </div>
    <ul class="nav-links">
      <li><a href="#home" class="active">Visão Geral</a></li>
      <li><a href="#settings">Configurações</a></li>
      <li><a href="#logs">Log de Eventos</a></li>
      <li><a href="#" class="logout-button">Sair</a></li>
    </ul>
  </nav>

  <section id="home">
    <div class="container">
      <div class="header">
        <h2>Painel do Administrador</h2>
        <p>Gerencie o sistema e monitore o status em tempo real.</p>
      </div>

      <div class="status-cards">
        <div class="card">
          <div class="card-header"><div class="card-title">Nível Atual (Principal)</div></div>
          <h2 id="admin-level-card" class="card-main-value" style="color: #2e7d32;">--%</h2>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Nível Reservatório</div></div>
          <h2 id="admin-res-level-card" class="card-main-value" style="color: #007bff;">--%</h2>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Status da Bomba</div></div>
          <h2 id="admin-pump-status-card" class="card-main-value">--</h2>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Status da Coleta</div></div>
          <h2 id="admin-collection-status-card" class="card-main-value">--</h2>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Status da Conexão ESP</div></div>
          <h2 id="admin-connection-status" class="card-main-value">--</h2>
          <p id="admin-last-seen" style="text-align:center;font-size:0.9rem;color:#6c757d;">Aguardando sinal...</p>
        </div>
      </div>

      <div class="tank-visualization-container">
        <div>
          <div class="tank">
            <div id="admin-water-main" class="water-level" style="height: 0%; background-color: #2e7d32;"></div>
          </div>
          <div class="tank-label">Caixa Principal (<span id="admin-level-percent-main">--</span>%)</div>
        </div>
        <div>
          <div class="tank">
            <div id="admin-water-res" class="water-level" style="height: 0%; background-color: #007bff;"></div>
          </div>
          <div class="tank-label">Reservatório (<span id="admin-level-percent-res">--</span>%)</div>
        </div>
      </div>
    </div>
  </section>

  <section id="settings">
    <div class="container">
      <h3 class="history-title">Configurações e Controle</h3>

      <div class="settings-card">
        <h4>Configurações do Sistema</h4>
        <div class="control-group">
          <label for="low-limit-input">Ligar Bomba Abaixo de (%):</label>
          <input type="number" id="low-limit-input" min="0" max="100">
        </div>
        <div class="control-group">
          <label for="high-limit-input">Desligar Bomba Acima de (%):</label>
          <input type="number" id="high-limit-input" min="0" max="100">
        </div>
        <button id="save-settings-button" class="btn-action btn-green" style="width:100%;margin-top:1rem;">Salvar Limites</button>
        <p id="settings-feedback" style="text-align:center;color:green;margin-top:1rem;"></p>
      </div>

      <div class="settings-card" style="margin-top:2rem;border-top-color:#ff9800;">
        <h4>Gerenciamento de Dados</h4>
        <div class="control-group">
          <label>Coleta de dados do sensor:</label>
          <button id="toggle-collection-button" class="btn-action">Aguardando...</button>
        </div>
        <div class="control-group">
          <label>Limpar histórico de consumo:</label>
          <button id="clear-history-button" class="btn-action btn-red">Limpar Histórico</button>
        </div>
        <div class="control-group">
          <label>Limpar log de eventos:</label>
          <button id="clear-logs-button" class="btn-action btn-red">Limpar Logs</button>
        </div>
        <p class="settings-info">
          <b>Pausar/Retomar Coleta:</b> Ativa/desativa envio de dados. <b>Limpar Histórico:</b> Apaga registros de nível. <b>Limpar Logs:</b> Apaga registros de eventos.
        </p>
      </div>

      <div class="settings-card" style="margin-top:2rem;border-top-color:#dc3545;">
        <h4>Ações Remotas</h4>
        <div class="control-group">
          <label>Reiniciar o dispositivo ESP8266:</label>
          <button id="restart-esp-button" class="btn-action btn-red">Reiniciar ESP</button>
        </div>
        <p class="settings-info"><b>Reiniciar ESP:</b> Força a reinicialização do microcontrolador.</p>
      </div>
    </div>
  </section>

  <section id="logs">
    <div class="container">
      <h3 class="history-title">Log de Eventos</h3>
      <div class="log-container">
        <ul id="log-entries">
          <li>Aguardando logs...</li>
        </ul>
      </div>
    </div>
  </section>

  <footer>
    <div class="footer-content"><p>&copy; 2025 AquaMonitor</p></div>
  </footer>

  <!-- Firebase SDKs (com defer e ordem garantida) -->
<script defer src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<!-- Seu script principal (força versão pra quebrar cache) -->
<script defer src="admin.js?v=12"></script>

  <!-- Log para confirmar carregamento -->
  <script>
    console.log("✅ Firebase SDKs carregados, iniciando admin.js...");
  </script>

  <!-- Força recarregar a versão mais nova -->
  <script src="admin.js?v=11"></script>

  <script>
(() => {
  // refs dos controles já existentes no seu HTML
  const autoSwitch = document.getElementById('auto-mode-switch');
  const motorBtn   = document.getElementById('motor-button');
  const motorText  = document.getElementById('motor-status'); // mostra LIGADA/DESLIGADA

  // evita erro se o dashboard.js ainda não montou Firebase
  if (!window.firebase || !firebase.apps.length) {
    console.warn('Firebase ainda não está pronto. Patch manual não inicializado.');
    return;
  }

  const db = firebase.database();
  const ctrlRef = db.ref('bomba/controle');

  // helper: muda modo no RTDB e espelha no UI
  async function setModoManual() {
    try {
      // marca manual no banco
      await ctrlRef.update({ modo: 'manual' });
      // espelha no UI: desliga o auto e habilita botão manual
      if (autoSwitch) autoSwitch.checked = false;
      if (motorBtn)   motorBtn.disabled = false;
    } catch (e) {
      console.error('Falha ao setar modo manual:', e);
    }
  }

  // click do botão manual
  motorBtn?.addEventListener('click', async () => {
    try {
      motorBtn.disabled = true;

      // 1) garante modo manual
      await setModoManual();

      // 2) decide comando baseado no texto do status atual (ou classe do botão)
      const statusAtual = (motorText?.textContent || '').trim().toUpperCase();
      // Se a bomba ESTÁ ligada -> comando é DESLIGAR, senão LIGAR
      const comando = statusAtual === 'LIGADA' ? 'DESLIGAR' : 'LIGAR';

      // 3) escreve o comando manual
      await ctrlRef.update({ comandoManual: comando });

      // 4) pequena espera para o ESP ler e agir, então limpa (opcional: o ESP já limpa)
      setTimeout(() => {
        ctrlRef.update({ comandoManual: 'NENHUM' }).catch(()=>{});
      }, 1200);

      // feedback visual: troca texto do botão
      if (comando === 'LIGAR') {
        motorBtn.textContent = 'Desligar Bomba';
        motorBtn.classList.remove('btn-motor-off');
        motorBtn.classList.add('btn-motor-on');
      } else {
        motorBtn.textContent = 'Ligar Bomba';
        motorBtn.classList.remove('btn-motor-on');
        motorBtn.classList.add('btn-motor-off');
      }
    } catch (e) {
      console.error('Falha no comando manual:', e);
    } finally {
      // reabilita depois de um curto intervalo pra evitar duplo clique
      setTimeout(() => (motorBtn.disabled = false), 800);
    }
  });

  // quando o usuário ligar o modo automático no switch, só espelha no banco
  autoSwitch?.addEventListener('change', async (ev) => {
    const on = ev.target.checked;
    try {
      await ctrlRef.update({ modo: on ? 'automatico' : 'manual' });
      // se voltou pro manual, garante que o botão fique habilitado
      if (!on && motorBtn) motorBtn.disabled = false;
      if (on && motorBtn)  motorBtn.disabled = true;
    } catch (e) {
      console.error('Falha ao atualizar modo:', e);
    }
  });
})();
</script>

</body>
</html>


