<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AquaMonitor – Login</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="./style.css?v=1.3.0"/>
</head>
<body>
  <main class="login-container">
    <div class="login-card">
      <h1 class="login-title">AquaMonitor</h1>
      <p class="login-subtitle">Entre com seu e-mail e senha</p>

      <form id="loginForm">
        <label>E-mail
          <input id="email" type="email" class="input" required placeholder="voce@exemplo.com"/>
        </label>
        <label>Senha
          <input id="password" type="password" class="input" required placeholder="Sua senha"/>
        </label>
        <button id="btnLogin" type="submit" class="btn btn-primary">Entrar</button>
        <p id="msg" class="msg"></p>
      </form>

      <details class="small muted" style="margin-top:12px;">
        <summary>Dica (opcional): criar/atualizar role na primeira vez</summary>
        <pre class="code">/usuarios/&lt;uid&gt;/role = "cliente"</pre>
      </details>
    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBOBbMzkTO2MvIxExVO8vlCOUgpeZp0rSY",
      authDomain: "aqua-monitor-login.firebaseapp.com",
      databaseURL: "https://aqua-monitor-login-default-rtdb.firebaseio.com",
      projectId: "aqua-monitor-login"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.database();

    // Redirecionamento por role
    auth.onAuthStateChanged(async (user) => {
      if (!user) return;

      // NÃO manter anônimo no login
      if (user.isAnonymous) {
        try { await auth.signOut(); } catch(e){}
        return;
      }
      try {
        const snap = await db.ref('usuarios/'+user.uid+'/role').once('value');
        const role = (snap.val() || '').toString().toLowerCase();
        if (role === 'admin')   window.location.replace('admin.html');
        else if (role === 'cliente') window.location.replace('index.html');
        else window.location.replace('index.html'); // sem role -> só leitura
      } catch (e) {
        window.location.replace('index.html');
      }
    });

    // Login formulário
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const pass  = document.getElementById('password').value.trim();
      const btn   = document.getElementById('btnLogin');
      const msg   = document.getElementById('msg');
      btn.disabled = true; btn.textContent = 'Entrando...'; msg.textContent = '';

      try {
        const cred = await auth.signInWithEmailAndPassword(email, pass);

        // OPCIONAL: se o role não existir, definir "cliente" por padrão
        const roleRef = db.ref('usuarios/'+cred.user.uid+'/role');
        const roleSnap = await roleRef.get();
        if (!roleSnap.exists()) await roleRef.set('cliente');

      } catch (err) {
        console.error(err);
        msg.textContent = 'E-mail ou senha inválidos.';
      } finally {
        btn.disabled = false; btn.textContent = 'Entrar';
      }
    });
  </script>
</body>
</html>
