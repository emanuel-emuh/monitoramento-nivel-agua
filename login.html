<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AquaMonitor – Login</title>

  <!-- Fonte + CSS exclusivo do login -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="./style.css?v=1.2.1" />
</head>
<body>
  <main class="login-container">
    <div class="login-card">
      <h1 class="login-title">AquaMonitor Login</h1>
      <p class="login-subtitle">Acesse sua conta</p>

      <form id="loginForm">
        <label>E-mail
          <input id="email" type="email" class="input" required placeholder="voce@exemplo.com" />
        </label>
        <label>Senha
          <input id="password" type="password" class="input" required placeholder="Sua senha" />
        </label>

        <button id="btnLogin" type="submit" class="btn btn-primary">Entrar</button>
        <p id="msg" class="msg"></p>
      </form>
    </div>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBOBbMzkTO2MvIxExVO8vlCOUgpeZp0rSY",
      authDomain: "aqua-monitor-login.firebaseapp.com",
      databaseURL: "https://aqua-monitor-login-default-rtdb.firebaseio.com",
      projectId: "aqua-monitor-login",
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.database();

    // NÃO redireciona se for anônimo; decide destino pela role
    auth.onAuthStateChanged(async (user) => {
      if (!user) return;

      // sessão anônima (criada no index) não deve sair do login
      if (user.isAnonymous) {
        try { await auth.signOut(); } catch(e){}
        return;
      }

      try {
        const snap = await db.ref('usuarios/'+user.uid+'/role').once('value');
        const role = (snap.val() || '').toString().toLowerCase();
        if (role === 'admin') window.location.replace('admin.html');
        else                  window.location.replace('index.html');
      } catch (e) {
        // se falhar a leitura, trate como cliente
        window.location.replace('index.html');
      }
    });

    // submit do formulário de login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const pass  = document.getElementById('password').value.trim();
      const btn   = document.getElementById('btnLogin');
      const msg   = document.getElementById('msg');
      btn.disabled = true; btn.textContent = 'Entrando...'; msg.textContent = '';
      try {
        await auth.signInWithEmailAndPassword(email, pass);
        // onAuthStateChanged fará o redirecionamento baseado na role
      } catch (err) {
        msg.textContent = 'E-mail ou senha inválidos.'; console.error(err);
      } finally {
        btn.disabled = false; btn.textContent = 'Entrar';
      }
    });
  </script>
</body>
</html>
