<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AquaMonitor - Dashboard</title>
    <link rel="stylesheet" href="painel.css">
</head>
<body>
    <nav class="navbar">
        <div class="logo"><div class="logo-icon">AM</div><h1>AquaMonitor</h1></div>
        <ul class="nav-links">
            <li><a href="#home" class="active">Dashboard</a></li>
            <li><a href="#configuracoes">Configurações</a></li>
            <li><a href="#" class="logout-button">Sair</a></li>
        </ul>
    </nav>
    <section id="home">
        <div class="container">
            <div class="header"><h2>Monitoramento de Nível de Água</h2><p>Sistema de monitoramento em tempo real do nível da caixa d'água</p></div>
            <div class="status-cards">
                <div class="card"><div class="card-header"><div class="card-title">Nível Atual</div><div class="card-icon" id="level-card-icon"><span id="level-card-value">--%</span></div></div><p id="level-card-text">Aguardando leitura...</p></div>
                <div class="card"><div class="card-header"><div class="card-title">Status da Bomba</div><div class="card-icon" id="pump-status-icon"><span id="pump-status-value">--</span></div></div><p id="pump-status-text">Aguardando status...</p></div>
                <div class="card"><div class="card-header"><div class="card-title">Modo de Operação</div><div class="card-icon" id="mode-icon"><span id="mode-value">--</span></div></div><p id="mode-text">Aguardando status...</p></div>
            </div>
            <div class="level-indicator"><div class="level-title">Nível da Caixa d'Água</div><div class="level-bar"><div id="level-fill" class="level-fill" style="width: 0%;"></div><div id="level-percentage" class="level-percentage">--%</div></div></div>
        </div>
    </section>
    <section id="configuracoes">
        <div class="container">
            <h3 class="history-title">Configurações e Controle</h3>
            <div class="settings-card">
                <h4>Controle da Bomba de Água</h4>
                <div class="motor-status-display">Status da Bomba: <span id="motor-status" class="status-indicator-off">--</span></div>
                <div class="control-group"><label for="auto-mode-switch">Modo Automático</label><label class="switch"><input type="checkbox" id="auto-mode-switch"><span class="slider round"></span></label></div>
                <div class="control-group"><label for="motor-button">Controle Manual</label><button id="motor-button" class="btn-motor-off" disabled>Ligar Bomba</button></div>
                 <p class="settings-info"><b>Modo Automático:</b> A bomba liga/desliga com base nos limites.<br><b>Modo Manual:</b> Desative o modo automático para o controle manual.</p>
            </div>
        </div>
    </section>
    <footer><div class="footer-content"><p>&copy; 2025 AquaMonitor</p></div></footer>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBOBbMzkTO2MvIxExVO8vlCOUgpeZp0rSY",
            authDomain: "aqua-monitor-login.firebaseapp.com",
            projectId: "aqua-monitor-login",
            databaseURL: "https://aqua-monitor-login-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            
            auth.onAuthStateChanged(user => { if (!user) window.location.href = 'login.html'; });
            document.querySelector('.logout-button').addEventListener('click', e => {
                e.preventDefault();
                auth.signOut().then(() => window.location.href = 'login.html');
            });

            // --- REFERÊNCIAS DA UI ---
            const levelFill = document.getElementById('level-fill');
            const levelPercentage = document.getElementById('level-percentage');
            const levelCardValue = document.getElementById('level-card-value');
            const levelCardIcon = document.getElementById('level-card-icon');
            const autoModeSwitch = document.getElementById('auto-mode-switch');
            const motorButton = document.getElementById('motor-button');
            const motorStatus = document.getElementById('motor-status');
            const pumpStatusIcon = document.getElementById('pump-status-icon');
            const pumpStatusValue = document.getElementById('pump-status-value');
            const modeIcon = document.getElementById('mode-icon');
            const modeValue = document.getElementById('mode-value');
            
            // --- REFERÊNCIAS DO REALTIME DATABASE ---
            const levelRef = database.ref('sensorData/level');
            const controlRef = database.ref('bomba/controle');

            // --- OUVINTES DE DADOS ---
            levelRef.on('value', snapshot => {
                const level = snapshot.val();
                if (level !== null) {
                    levelFill.style.width = level + '%';
                    levelPercentage.textContent = level + '%';
                    levelCardValue.textContent = level + '%';

                    // Muda a cor do ícone de nível
                    if (level <= 50) {
                        levelCardIcon.className = 'card-icon icon-red';
                    } else if (level < 95) {
                        levelCardIcon.className = 'card-icon icon-orange';
                    } else {
                        levelCardIcon.className = 'card-icon icon-green';
                    }
                }
            });

            controlRef.on('value', snapshot => {
                const data = snapshot.val();
                if (data) {
                    // Atualiza Status da Bomba
                    motorStatus.textContent = data.statusBomba;
                    pumpStatusValue.textContent = data.statusBomba === 'LIGADA' ? 'ON' : 'OFF';
                    if (data.statusBomba === 'LIGADA') {
                        motorStatus.className = 'status-indicator-on';
                        pumpStatusIcon.className = 'card-icon icon-green'; // <-- COR VERDE AQUI
                        motorButton.textContent = 'Desligar Bomba';
                        motorButton.className = 'btn-motor-on';
                    } else {
                        motorStatus.className = 'status-indicator-off';
                        pumpStatusIcon.className = 'card-icon icon-red'; // Cor vermelha se desligada
                        motorButton.textContent = 'Ligar Bomba';
                        motorButton.className = 'btn-motor-off';
                    }

                    // Atualiza Modo de Operação
                    modeValue.textContent = data.modo === 'automatico' ? 'AUTO' : 'MANUAL';
                    if (data.modo === 'automatico') {
                        autoModeSwitch.checked = true;
                        motorButton.disabled = true;
                        modeIcon.className = 'card-icon icon-green'; // <-- COR VERDE AQUI
                    } else {
                        autoModeSwitch.checked = false;
                        motorButton.disabled = false;
                        modeIcon.className = 'card-icon icon-orange'; // Cor laranja para manual
                    }
                }
            });

            // --- ENVIAR COMANDOS ---
            autoModeSwitch.addEventListener('change', () => {
                const newMode = autoModeSwitch.checked ? 'automatico' : 'manual';
                controlRef.update({ modo: newMode });
            });

            motorButton.addEventListener('click', () => {
                const newCommand = motorButton.textContent.includes('Ligar') ? 'LIGAR' : 'DESLIGAR';
                controlRef.update({ comandoManual: newCommand });
            });
        });
    </script>
</body>
</html>
