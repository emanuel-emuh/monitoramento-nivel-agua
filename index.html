<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AquaMonitor - Dashboard</title>
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <div class="logo-icon">AM</div>
            <h1>AquaMonitor</h1>
        </div>
        <ul class="nav-links">
            <li><a href="#home" class="active">Dashboard</a></li>
            <li><a href="#history">Histórico</a></li>
            <li><a href="#configuracoes">Configurações</a></li>
            <li><a href="#" class="logout-button">Sair</a></li>
        </ul>
    </nav>
    <section id="home">
        <div class="container">
            <div class="header">
                <h2>Monitoramento de Nível de Água</h2>
                <p>Sistema de monitoramento em tempo real do nível da caixa d'água</p>
            </div>
            <div class="status-cards">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Status do Sistema</div>
                        <div class="card-icon icon-green">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                        </div>
                    </div>
                    <p id="system-status-text">Conectado e recebendo dados em tempo real.</p>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Nível Atual</div>
                        <div class="card-icon icon-green" id="level-card-icon">
                            <span id="level-card-value">--%</span>
                        </div>
                    </div>
                    <p id="level-card-text">Aguardando a primeira leitura do sensor...</p>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Última Atualização</div>
                        <div class="card-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        </div>
                    </div>
                    <p id="last-update">--:--</p>
                </div>
            </div>
            <div class="level-indicator">
                <div class="level-title">Nível da Caixa d'Água</div>
                <div class="level-bar">
                    <div id="level-fill" class="level-fill" style="width: 0%;"></div>
                    <div id="level-percentage" class="level-percentage">--%</div>
                </div>
            </div>
            <div id="history" class="history">
                <h3 class="history-title">Histórico Recente</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Nível (%)</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body"></tbody>
                </table>
            </div>
        </div>
    </section>
    <section id="configuracoes">
        <div class="container">
            <h3 class="history-title">Configurações e Controle</h3>
            <div class="settings-card">
                <h4>Controle da Bomba de Água</h4>
                <div class="motor-status-display">
                    Status da Bomba: <span id="motor-status" class="status-indicator-off">--</span>
                </div>
                <div class="control-group">
                    <label for="auto-mode-switch">Modo Automático</label>
                    <label class="switch">
                        <input type="checkbox" id="auto-mode-switch">
                        <span class="slider round"></span>
                    </label>
                </div>
                <div class="control-group">
                    <label for="motor-button">Controle Manual</label>
                    <button id="motor-button" class="btn-motor-off" disabled>Ligar Bomba</button>
                </div>
                 <p class="settings-info">
                    <b>Modo Automático:</b> A bomba liga quando o nível estiver abaixo de 30% e desliga ao atingir 95%.<br>
                    <b>Modo Manual:</b> Desative o modo automático para poder ligar ou desligar a bomba manualmente.
                </p>
            </div>
        </div>
    </section>
    <footer>
        <div class="footer-content">
            <p>&copy; 2025 AquaMonitor - Sistema de Monitoramento de Nível de Água</p>
        </div>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBOBbMzkTO2MvIxExVO8vlCOUgpeZp0rSY",
            authDomain: "aqua-monitor-login.firebaseapp.com",
            projectId: "aqua-monitor-login",
            storageBucket: "aqua-monitor-login.appspot.com",
            messagingSenderId: "945598154686",
            appId: "1:945598154686:web:49a1f631557722945b5bef",
            measurementId: "G-EY4C1MJRYZ"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>
    <script>
        // 1. AUTENTICAÇÃO E LOGOUT
        document.addEventListener('DOMContentLoaded', function () {
            auth.onAuthStateChanged(function (user) {
                if (!user) { window.location.href = 'login.html'; }
            });
            const logoutButton = document.querySelector('.logout-button');
            logoutButton.addEventListener('click', function (e) {
                e.preventDefault();
                auth.signOut().then(() => { window.location.href = 'login.html'; });
            });
        });
    </script>
    <script>
        // 2. LÓGICA DO DASHBOARD DE NÍVEL EM TEMPO REAL
        document.addEventListener('DOMContentLoaded', function () {
            const levelFill = document.getElementById('level-fill');
            const levelPercentage = document.getElementById('level-percentage');
            const levelCardValue = document.getElementById('level-card-value');
            const levelCardText = document.getElementById('level-card-text');
            const levelCardIcon = document.getElementById('level-card-icon');
            const lastUpdateText = document.getElementById('last-update');
            const historyTableBody = document.getElementById('history-table-body');
            const sensorDocRef = db.doc("sensorData/currentLevel");

            sensorDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    // *** CORREÇÃO APLICADA AQUI ***
                    // Acessamos o objeto 'fields' que o ESP envia, que contém o valor.
                    if (data.fields && data.fields.level && data.fields.level.integerValue) {
                        const newLevel = data.fields.level.integerValue;
                        updateDashboardUI(parseInt(newLevel));
                    }
                } else { console.error("Documento do sensor não encontrado!"); }
            }, (error) => { console.error("Erro ao escutar o sensor: ", error); });

            function updateDashboardUI(level) {
                levelFill.style.width = level + '%';
                levelPercentage.textContent = level + '%';
                levelCardValue.textContent = level + '%';
                
                if (level < 30) {
                    levelFill.className = 'level-fill level-low';
                    levelCardIcon.className = 'card-icon icon-red';
                    levelCardText.textContent = 'Nível baixo. Reabastecimento necessário.';
                } else if (level < 70) {
                    levelFill.className = 'level-fill level-medium';
                    levelCardIcon.className = 'card-icon';
                    levelCardIcon.style.backgroundColor = '#ff9800';
                    levelCardText.textContent = 'Nível moderado. Consumo normal.';
                } else {
                    levelFill.className = 'level-fill level-high';
                    levelCardIcon.className = 'card-icon icon-green';
                    levelCardText.textContent = 'Nível adequado. Caixa d\'água cheia.';
                }

                const now = new Date();
                const timeString = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                lastUpdateText.textContent = `Agora - ${timeString}`;
                addHistoryEntry(level, now);
            }
            
            function addHistoryEntry(level, timestamp) {
                const newRow = historyTableBody.insertRow(0);
                const dateString = timestamp.toLocaleDateString('pt-BR');
                const timeString = timestamp.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const isAlert = level < 30;
                const statusClass = isAlert ? 'status-alert' : 'status-normal';
                const statusText = isAlert ? 'Atenção' : 'Normal';

                newRow.innerHTML = `
                    <td>${dateString} ${timeString}</td>
                    <td>${level}%</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>`;
                if (historyTableBody.rows.length > 5) {
                    historyTableBody.deleteRow(5);
                }
            }
        });
    </script>
    <script>
        // 3. LÓGICA DE CONTROLE DA BOMBA (CORRIGIDA)
        document.addEventListener('DOMContentLoaded', function () {
            const autoModeSwitch = document.getElementById('auto-mode-switch');
            const motorButton = document.getElementById('motor-button');
            const motorStatus = document.getElementById('motor-status');
            const controlDocRef = db.doc("bomba/controle");

            // *** CORREÇÃO APLICADA AQUI ***
            // Agora o JavaScript envia os comandos no mesmo formato que o ESP espera ler.
            autoModeSwitch.addEventListener('change', function() {
                const newMode = this.checked ? 'automatico' : 'manual';
                const commandData = {
                    fields: { modo: { stringValue: newMode } }
                };
                controlDocRef.set(commandData, { merge: true });
            });

            motorButton.addEventListener('click', function() {
                const newCommand = motorButton.textContent.includes('Ligar') ? 'LIGAR' : 'DESLIGAR';
                const commandData = {
                    fields: { comandoManual: { stringValue: newCommand } }
                };
                controlDocRef.set(commandData, { merge: true });
            });

            // *** CORREÇÃO APLICADA AQUI ***
            // Agora o JavaScript lê o status no mesmo formato que o ESP escreve.
            controlDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data.fields && data.fields.statusBomba && data.fields.modo) {
                        const statusBomba = data.fields.statusBomba.stringValue;
                        const modo = data.fields.modo.stringValue;

                        if (statusBomba === 'LIGADA') {
                            motorStatus.textContent = 'LIGADA';
                            motorStatus.className = 'status-indicator-on';
                            motorButton.textContent = 'Desligar Bomba';
                            motorButton.className = 'btn-motor-on';
                        } else {
                            motorStatus.textContent = 'DESLIGADA';
                            motorStatus.className = 'status-indicator-off';
                            motorButton.textContent = 'Ligar Bomba';
                            motorButton.className = 'btn-motor-off';
                        }
                        if (modo === 'automatico') {
                            autoModeSwitch.checked = true;
                            motorButton.disabled = true;
                        } else {
                            autoModeSwitch.checked = false;
                            motorButton.disabled = false;
                        }
                    }
                } else {
                    // Se o documento não existir, o ESP irá criá-lo na próxima atualização.
                    console.log("Aguardando documento de controle ser criado pelo ESP...");
                }
            });
        });
    </script>
</body>
</html>
