<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="color-scheme" content="light" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ÁguaMonitor – Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  
  <link rel="stylesheet" href="main.css" />
</head>
<body class="user"> <header class="main-header" role="banner">
    <div class="brand">
      <div class="brand-icon">AM</div>
      <span>ÁguaMonitor</span>
    </div>

    <small id="conn-dot" class="conn" aria-live="polite" style="display:flex; align-items:center; gap:6px;">
      <span id="conn-led" class="pill" style="width:10px; height:10px; padding:0; background:#bbb;"></span>
      <span id="conn-txt">Conectando...</span>
    </small>

    <nav class="header-actions">
      <a id="btn-sair" href="login.html">Sair</a>
    </nav>
  </header>

  <main class="app-container" role="main">
    <h1 style="font-size:1.5rem; margin-bottom:24px;">Visão Geral</h1>

    <section class="grid grid-2">
      <article class="card">
        <h2 class="card-title">Caixa Principal</h2>

        <div class="kpi-value" id="main-level-value">--%</div>
        <div class="kpi-sub"><span id="main-level-liters">-- L</span></div>

        <div class="progress-bar" role="progressbar" aria-label="Percentual da caixa">
          <div id="level-fill-main" class="progress-fill" style="width:0%"></div>
        </div>

        <div class="tank-visual" aria-label="Visual da caixa principal">
          <div id="client-water-main" class="water-level" style="height:0%"></div>
        </div>
        <p style="text-align:center; font-size:0.85rem; color:var(--text-muted); margin-top:5px;">
          Principal (<span id="client-level-percent-main">0</span>%)
        </p>
      </article>

      <article class="card">
        <h2 class="card-title">Reservatório</h2>

        <div class="kpi-value" id="res-level-value">--%</div>
        <div class="kpi-sub"><span id="res-level-liters">-- L</span></div>

        <div class="progress-bar" role="progressbar" aria-label="Percentual do reservatório">
          <div id="level-fill-res" class="progress-fill" style="width:0%"></div>
        </div>

        <div class="tank-visual" aria-label="Visual do reservatório">
          <div id="client-water-res" class="water-level" style="height:0%"></div>
        </div>
        <p style="text-align:center; font-size:0.85rem; color:var(--text-muted); margin-top:5px;">
          Reservatório (<span id="client-level-percent-res">0</span>%)
        </p>
      </article>
    </section>

    <section class="grid grid-3" style="margin-top:24px;">
      
      <article class="card highlight">
        <h3>Status da Bomba</h3>
        <div><span id="pump-status-value" class="pill">--</span></div>
        <p id="pump-status-text" style="color:var(--text-muted); font-size:0.9rem; margin-top:8px;">
          A aguardar dados...
        </p>
      </article>

      <article class="card highlight">
        <h3>Modo de Operação</h3>
        <div><span id="mode-value" class="pill">--</span></div>
        <p id="mode-text" style="color:var(--text-muted); font-size:0.9rem; margin-top:8px;">
          A aguardar dados...
        </p>
      </article>

      <article class="card">
        <h3>Controle da Bomba</h3>

        <div style="display:flex; align-items:center; gap:10px; margin-bottom:16px;">
          <input type="checkbox" id="auto-mode-switch" style="width:18px; height:18px; accent-color:var(--primary);" />
          <label for="auto-mode-switch" style="font-weight:600;">Modo Automático</label>
        </div>

        <button id="motor-button" type="button" class="btn btn-danger">Desligar Bomba</button>

        <p style="color:var(--text-muted); font-size:0.85rem; margin-top:10px;">
          Status atual: <b id="motor-status">--</b>
        </p>
      </article>
    </section>

    <section style="margin-top:24px;">
      <article class="card" style="border-left: 4px solid var(--warning);">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h3>Modo Econômico (Férias)</h3>
          <span class="pill on" style="width:10px; height:10px; padding:0;"></span>
        </div>

        <p style="color:var(--text-muted); font-size:0.9rem;">
          Reduz o consumo: aplica limites <b>15%</b> (liga) e <b>50%</b> (desliga) enquanto ativo.
        </p>

        <button id="btn-ferias" type="button" class="btn btn-primary" style="max-width:200px; margin-top:10px;">
          Ativar Modo Férias
        </button>
      </article>
    </section>

    <section class="grid grid-2" style="margin-top:24px;">
      <article class="card">
        <h3>Consumo Estimado</h3>
        <div id="consumption-value" class="kpi-value">-- L/dia</div>
        <p id="consumption-text" style="color:var(--text-muted);">Estimando...</p>

        <hr style="border:0; border-top:1px solid var(--border); margin:16px 0;">

        <h4 style="margin:0 0 8px;">Exportar Histórico</h4>
        <div class="grid grid-2" style="gap:10px;">
           <select id="export-range" class="input">
             <option value="7">Últimos 7 dias</option>
             <option value="30">Últimos 30 dias</option>
           </select>
           <button id="btn-export-csv" type="button" class="btn btn-secondary">Baixar Planilha</button>
        </div>
      </article>

      <article class="card">
        <h3>Histórico de Nível</h3>
        <div style="position:relative; height:200px;">
          <canvas id="levelChart"></canvas>
        </div>
      </article>
    </section>
  </main>

  <noscript>Ative o JavaScript para usar o painel.</noscript>

  <script defer src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  
  <script defer src="./dashboard.js?v=13.4"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const sair = document.getElementById('btn-sair');
      if (!sair) return;
      sair.addEventListener('click', async function(ev){
        ev.preventDefault();
        try { if (window.firebase?.auth) await firebase.auth().signOut(); } catch(e){}
        window.location.href = 'login.html';
      });
    });
  </script>
</body>
</html>