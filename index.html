<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AquaMonitor - Dashboard</title>
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <div class="logo-icon">AM</div>
            <h1>AquaMonitor</h1>
        </div>
        <ul class="nav-links">
            <li><a href="#home" class="active">Dashboard</a></li>
            <li><a href="#configuracoes">Configurações</a></li>
            <li><a href="#" class="logout-button">Sair</a></li>
        </ul>
    </nav>
    <section id="home">
        <div class="container">
            <div class="header">
                <h2>Monitoramento de Nível de Água</h2>
                <p>Sistema de monitoramento em tempo real do nível da caixa d'água</p>
            </div>
            <div class="status-cards">
                <div class="card">
                    <div class="card-header"><div class="card-title">Status do Sistema</div><div class="card-icon icon-green"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></div></div>
                    <p id="system-status-text">Conectado e recebendo dados.</p>
                </div>
                <div class="card">
                    <div class="card-header"><div class="card-title">Nível Atual</div><div class="card-icon icon-green" id="level-card-icon"><span id="level-card-value">--%</span></div></div>
                    <p id="level-card-text">Aguardando leitura do sensor...</p>
                </div>
                <div class="card">
                    <div class="card-header"><div class="card-title">Status da Bomba</div><div class="card-icon"><span id="pump-status-icon">--</span></div></div>
                    <p id="pump-status-text">Aguardando status...</p>
                </div>
            </div>
            <div class="level-indicator">
                <div class="level-title">Nível da Caixa d'Água</div>
                <div class="level-bar">
                    <div id="level-fill" class="level-fill" style="width: 0%;"></div>
                    <div id="level-percentage" class="level-percentage">--%</div>
                </div>
            </div>
        </div>
    </section>
    <section id="configuracoes">
        <div class="container">
            <h3 class="history-title">Configurações e Controle</h3>
            <div class="settings-card">
                <h4>Controle da Bomba de Água</h4>
                <div class="motor-status-display">Status da Bomba: <span id="motor-status" class="status-indicator-off">--</span></div>
                <div class="control-group">
                    <label for="auto-mode-switch">Modo Automático</label>
                    <label class="switch"><input type="checkbox" id="auto-mode-switch"><span class="slider round"></span></label>
                </div>
                <div class="control-group">
                    <label for="motor-button">Controle Manual</label>
                    <button id="motor-button" class="btn-motor-off" disabled>Ligar Bomba</button>
                </div>
                 <p class="settings-info"><b>Modo Automático:</b> A bomba liga/desliga com base nos limites definidos pelo admin.<br><b>Modo Manual:</b> Desative o modo automático para poder ligar/desligar a bomba manualmente.</p>
            </div>
        </div>
    </section>
    <footer>
        <div class="footer-content"><p>&copy; 2025 AquaMonitor</p></div>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js"></script>

    <script>
        // CÓDIGO JAVASCRIPT ATUALIZADO PARA FIREBASE v9
        const firebaseConfig = {
            apiKey: "AIzaSyBOBbMzkTO2MvIxExVO8vlCOUgpeZp0rSY",
            authDomain: "aqua-monitor-login.firebaseapp.com",
            projectId: "aqua-monitor-login",
            storageBucket: "aqua-monitor-login.appspot.com",
            messagingSenderId: "945598154686",
            appId: "1:945598154686:web:49a1f631557722945b5bef"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', function () {
            
            // --- AUTENTICAÇÃO E LOGOUT ---
            auth.onAuthStateChanged(user => {
                if (!user) { window.location.href = 'login.html'; }
            });

            document.querySelector('.logout-button').addEventListener('click', e => {
                e.preventDefault();
                auth.signOut().then(() => { window.location.href = 'login.html'; });
            });

            // --- ELEMENTOS DA UI ---
            const levelFill = document.getElementById('level-fill');
            const levelPercentage = document.getElementById('level-percentage');
            const levelCardValue = document.getElementById('level-card-value');
            const pumpStatusText = document.getElementById('pump-status-text');
            const pumpStatusIcon = document.getElementById('pump-status-icon');
            
            const autoModeSwitch = document.getElementById('auto-mode-switch');
            const motorButton = document.getElementById('motor-button');
            const motorStatus = document.getElementById('motor-status');
            
            // --- REFERÊNCIAS DO FIRESTORE ---
            const sensorDocRef = db.doc("sensorData/currentLevel");
            const controlDocRef = db.doc("bomba/controle");

            // --- LÓGICA DE LEITURA DE DADOS ---
            sensorDocRef.onSnapshot(doc => {
                if (doc.exists && doc.data().level !== undefined) {
                    const level = parseInt(doc.data().level);
                    levelFill.style.width = level + '%';
                    levelPercentage.textContent = level + '%';
                    levelCardValue.textContent = level + '%';
                }
            });

            controlDocRef.onSnapshot(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    const statusBomba = data.statusBomba;
                    const modo = data.modo;

                    console.log("Status recebido:", data);

                    // Atualiza o status visual
                    motorStatus.textContent = statusBomba;
                    pumpStatusText.textContent = `Operando em modo ${modo}.`;
                    pumpStatusIcon.textContent = statusBomba === 'LIGADA' ? 'ON' : 'OFF';
                    
                    if (statusBomba === 'LIGADA') {
                        motorStatus.className = 'status-indicator-on';
                        motorButton.textContent = 'Desligar Bomba';
                        motorButton.className = 'btn-motor-on';
                    } else {
                        motorStatus.className = 'status-indicator-off';
                        motorButton.textContent = 'Ligar Bomba';
                        motorButton.className = 'btn-motor-off';
                    }

                    // Atualiza o modo
                    if (modo === 'automatico') {
                        autoModeSwitch.checked = true;
                        motorButton.disabled = true;
                    } else {
                        autoModeSwitch.checked = false;
                        motorButton.disabled = false;
                    }
                }
            });

            // --- LÓGICA DE ENVIO DE COMANDOS ---
            autoModeSwitch.addEventListener('change', () => {
                const newMode = autoModeSwitch.checked ? 'automatico' : 'manual';
                console.log('Enviando comando de modo:', newMode);
                controlDocRef.update({ modo: newMode }).catch(err => console.error("Erro ao mudar modo:", err));
            });

            motorButton.addEventListener('click', () => {
                const newCommand = motorButton.textContent.includes('Ligar') ? 'LIGAR' : 'DESLIGAR';
                console.log('Enviando comando manual:', newCommand);
                controlDocRef.update({ comandoManual: newCommand }).catch(err => console.error("Erro ao enviar comando:", err));
            });
        });
    </script>
</body>
</html>
